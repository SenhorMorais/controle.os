<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gest√£o de O.S</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öôÔ∏è</text></svg>">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1042 50%, #0a0e27 100%);
            min-height: 100vh;
            padding: 1rem;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 { color: white; font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem; }
        .header p { color: #c7d2fe; font-size: 1rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.3));
            border-radius: 1rem;
            padding: 1.5rem;
            color: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        .stat-card p { font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem; }
        .stat-card h2 { font-size: 2.5rem; font-weight: bold; }
        .stat-card.green { background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3)); }
        .stat-card.purple { background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(124, 58, 237, 0.3)); }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .card h2 { color: white; font-size: 1.5rem; margin-bottom: 1.5rem; font-weight: bold; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { color: #c7d2fe; font-size: 0.875rem; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: white;
            font-size: 1rem;
        }
        .form-group textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        
        .btn-group { display: flex; gap: 0.75rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .btn-secondary { background: rgba(255, 255, 255, 0.2); color: white; }
        .btn-danger { background: rgba(239, 68, 68, 0.8); color: white; }
        
        .orders-list { display: grid; gap: 1rem; }
        .order-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .order-header { display: flex; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap; align-items: center; }
        .order-number { color: white; font-size: 1.5rem; font-weight: bold; }
        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-aberta { background: rgba(156,163,175,0.3); color: #d1d5db; }
        .status-andamento { background: rgba(59,130,246,0.3); color: #93c5fd; }
        .status-pausada { background: rgba(251,191,36,0.3); color: #fde047; }
        .status-concluida { background: rgba(16,185,129,0.3); color: #6ee7b7; }
        .status-cancelada { background: rgba(239,68,68,0.3); color: #fca5a5; }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Gest√£o de O.S</h1>
            <p>Controle suas Ordens de Servi√ßo de forma simples e r√°pida</p>
        </div>

        <!-- Estat√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <p>üìä Total de O.S</p>
                <h2 id="totalOS">0</h2>
            </div>
            <div class="stat-card green">
                <p>‚úÖ Conclu√≠das</p>
                <h2 id="totalConcluidas">0</h2>
            </div>
            <div class="stat-card purple">
                <p>üìÖ Hoje</p>
                <h2 id="totalHoje">0</h2>
            </div>
        </div>

        <!-- Formul√°rio -->
        <div class="card">
            <h2 id="formTitle">‚ûï Adicionar Nova O.S</h2>
            <form onsubmit="event.preventDefault(); saveOrder();">
                <div class="form-grid">
                    <div class="form-group">
                        <label>üìù N√∫mero da O.S *</label>
                        <input type="text" id="numeroOS" placeholder="Ex: OS-001" list="osRecentes" required />
                        <datalist id="osRecentes"></datalist>
                    </div>
                    <div class="form-group">
                        <label>üìÖ Data *</label>
                        <input type="date" id="data" required />
                    </div>
                </div>
                <div class="form-group">
                    <label>üìã Descri√ß√£o *</label>
                    <textarea id="descricao" placeholder="Descreva o servi√ßo..." required></textarea>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>üïê Hora In√≠cio</label>
                        <input type="time" id="horaInicio" />
                    </div>
                    <div class="form-group">
                        <label>üïê Hora Fim</label>
                        <input type="time" id="horaFim" />
                    </div>
                    <div class="form-group">
                        <label>üçΩÔ∏è Descontar Almo√ßo? (1h 25min)</label>
                        <select id="descontarAlmoco">
                            <option value="nao">‚ùå N√£o</option>
                            <option value="sim">‚úÖ Sim</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìä Status *</label>
                        <select id="status" required>
                            <option value="Aberta">üîµ Aberta</option>
                            <option value="Em Andamento">üîÑ Em Andamento</option>
                            <option value="Pausada">‚è∏Ô∏è Pausada</option>
                            <option value="Conclu√≠da">‚úÖ Conclu√≠da</option>
                            <option value="Cancelada">‚ùå Cancelada</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">
                        üíæ <span id="btnText">Salvar O.S</span>
                    </button>
                    <button type="button" class="btn btn-secondary" id="btnCancel" onclick="cancelEdit()" style="display:none;">
                        ‚ùå Cancelar
                    </button>
                </div>
            </form>
        </div>

        <!-- FILTRO POR M√äS -->
        <div class="card">
            <h2>üîé Buscar O.S por M√™s</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>üìÖ M√™s</label>
                    <input type="month" id="filtroMes" />
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="filtrarMes()">üîç Buscar</button>
                </div>
            </div>
            <div class="btn-group" style="margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="baixarRelatorioMes()">üìÑ Relat√≥rio do M√™s</button>
                <button class="btn btn-secondary" onclick="baixarRelatorioSemana()">üìÑ Relat√≥rio da Semana</button>
            </div>
        </div>

        <!-- Lista -->
        <div class="card">
            <h2>üìã Suas O.S (<span id="orderCount">0</span>)</h2>
            <input 
                type="text" 
                id="searchBox" 
                placeholder="üîç Buscar..." 
                style="width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.75rem; padding: 0.75rem 1rem; color: white; margin-bottom: 1rem;"
                oninput="buscarOS(this.value)"
            />
            <div class="orders-list" id="ordersList"></div>
        </div>
    </div>

    <script>
        let orders = [];
        let editingId = null;

        function loadOrders() {
            const saved = localStorage.getItem('ordens-servico');
            if (saved) {
                try {
                    orders = JSON.parse(saved);
                } catch (e) {
                    orders = [];
                }
            }
            renderOrders();
            updateStats();
            atualizarListaOSRecentes();
        }

        function saveToStorage() {
            localStorage.setItem('ordens-servico', JSON.stringify(orders));
        }

        function calculateDuration(inicio, fim, descontarAlmoco) {
            if (!inicio || !fim) return '-';
            const [h1, m1] = inicio.split(':').map(Number);
            const [h2, m2] = fim.split(':').map(Number);
            let total = (h2 * 60 + m2) - (h1 * 60 + m1);
            if (total < 0) return '-';
            if (descontarAlmoco === 'sim') total -= 85;
            if (total < 0) total = 0;
            return `${Math.floor(total / 60)}h ${total % 60}m`;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span><span>${message}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function saveOrder() {
            const numOS = document.getElementById('numeroOS').value.trim();
            const desc = document.getElementById('descricao').value.trim();
            const dt = document.getElementById('data').value;
            const inicio = document.getElementById('horaInicio').value;
            const fim = document.getElementById('horaFim').value;
            const stat = document.getElementById('status').value;
            const almoco = document.getElementById('descontarAlmoco').value;

            if (!numOS || !desc || !dt) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }

            const order = {
                id: editingId || Date.now(),
                numeroOS: numOS,
                descricao: desc,
                data: dt,
                horaInicio: inicio,
                horaFim: fim,
                status: stat,
                descontarAlmoco: almoco
            };

            if (editingId) {
                orders[orders.findIndex(o => o.id === editingId)] = order;
                showToast('O.S atualizada!');
            } else {
                orders.push(order);
                showToast('O.S cadastrada!');
            }

            saveToStorage();
            renderOrders();
            updateStats();
            atualizarListaOSRecentes();
            clearForm();
        }

        function editOrder(id) {
            const o = orders.find(o => o.id === id);
            if (!o) return;
            document.getElementById('numeroOS').value = o.numeroOS;
            document.getElementById('descricao').value = o.descricao;
            document.getElementById('data').value = o.data;
            document.getElementById('horaInicio').value = o.horaInicio || '';
            document.getElementById('horaFim').value = o.horaFim || '';
            document.getElementById('status').value = o.status;
            document.getElementById('descontarAlmoco').value = o.descontarAlmoco || 'nao';
            editingId = id;
            document.getElementById('formTitle').textContent = '‚úèÔ∏è Editar O.S';
            document.getElementById('btnText').textContent = 'Atualizar';
            document.getElementById('btnCancel').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteOrder(id) {
            if (confirm('Excluir este apontamento?')) {
                orders = orders.filter(o => o.id !== id);
                saveToStorage();
                renderOrders();
                updateStats();
                showToast('Apontamento exclu√≠do!');
            }
        }

        function cancelEdit() {
            clearForm();
        }

        function clearForm() {
            document.getElementById('numeroOS').value = '';
            document.getElementById('descricao').value = '';
            document.getElementById('data').value = '';
            document.getElementById('horaInicio').value = '';
            document.getElementById('horaFim').value = '';
            document.getElementById('status').value = 'Aberta';
            document.getElementById('descontarAlmoco').value = 'nao';
            editingId = null;
            document.getElementById('formTitle').textContent = '‚ûï Adicionar Nova O.S';
            document.getElementById('btnText').textContent = 'Salvar O.S';
            document.getElementById('btnCancel').style.display = 'none';
            document.getElementById('data').valueAsDate = new Date();
        }

        function atualizarListaOSRecentes() {
            const numerosUnicos = [...new Set(orders.map(o => o.numeroOS))];
            document.getElementById('osRecentes').innerHTML = numerosUnicos.map(num => `<option value="${num}">`).join('');
        }

        document.getElementById('numeroOS').addEventListener('input', function() {
            const numeroDigitado = this.value.trim();
            if (!numeroDigitado || editingId) return;
            const osExistente = orders.filter(o => o.numeroOS === numeroDigitado).sort((a, b) => new Date(b.data) - new Date(a.data))[0];
            if (osExistente) {
                document.getElementById('descricao').value = osExistente.descricao;
                document.getElementById('status').value = osExistente.status;
            }
        });

        function renderOrders(lista = orders) {
            const cont = document.getElementById('ordersList');
            const ordensAgrupadas = {};
            lista.forEach(order => {
                if (!ordensAgrupadas[order.numeroOS]) ordensAgrupadas[order.numeroOS] = [];
                ordensAgrupadas[order.numeroOS].push(order);
            });

            const osUnicas = Object.keys(ordensAgrupadas);
            document.getElementById('orderCount').textContent = osUnicas.length;

            if (osUnicas.length === 0) {
                cont.innerHTML = '<div style="color:#c7d2fe; text-align:center; padding:2rem;">Nenhuma O.S cadastrada</div>';
                return;
            }

            cont.innerHTML = osUnicas.map(numeroOS => {
                const apontamentos = ordensAgrupadas[numeroOS];
                apontamentos.sort((a, b) => new Date(b.data) - new Date(a.data));
                const ultimoApontamento = apontamentos[0];
                const status = ultimoApontamento.status;
                const cls = {
                    'Aberta': 'status-aberta',
                    'Em Andamento': 'status-andamento',
                    'Pausada': 'status-pausada',
                    'Conclu√≠da': 'status-concluida',
                    'Cancelada': 'status-cancelada'
                }[status] || 'status-aberta';

                const listaApontamentos = apontamentos.map(apt => {
                    const dataFormatada = new Date(apt.data + 'T00:00:00').toLocaleDateString('pt-BR');
                    const duracao = apt.horaInicio && apt.horaFim ? calculateDuration(apt.horaInicio, apt.horaFim, apt.descontarAlmoco || 'nao') : '-';
                    return `
                        <div style="background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem; border-left: 3px solid #6366f1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <div style="color:#c7d2fe; font-size:0.85rem;">
                                    üìÖ ${dataFormatada} ${apt.horaInicio ? '| üïê ' + apt.horaInicio + ' - ' + (apt.horaFim || '...') : ''} ${apt.horaInicio && apt.horaFim ? '| ‚è± ' + duracao : ''} ${apt.descontarAlmoco === 'sim' ? '<span style="color: #fde047;">(üçΩÔ∏è -1h25min)</span>' : ''}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class='btn btn-secondary' style='padding:0.25rem 0.75rem; font-size: 0.8rem;' onclick='editOrder(${apt.id})'>‚úèÔ∏è</button>
                                    <button class='btn btn-danger' style='padding:0.25rem 0.75rem; font-size: 0.8rem;' onclick='deleteOrder(${apt.id})'>üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                return `<div class='order-card'>
                    <div class='order-header'>
                        <span class='order-number'>${numeroOS}</span>
                        <span class='status-badge ${cls}'>${status}</span>
                    </div>
                    <div style='color:#c7d2fe; margin-top:0.5rem;'>${ultimoApontamento.descricao}</div>
                    <div style='color:#a5b4fc; margin-top:0.75rem; font-size:0.85rem; font-weight: 600;'>
                        üìä ${apontamentos.length} apontamento(s)
                    </div>
                    ${listaApontamentos}
                </div>`;
            }).join('');
        }

        function updateStats() {
            const osUnicas = [...new Set(orders.map(o => o.numeroOS))];
            document.getElementById('totalOS').textContent = osUnicas.length;
            
            const osConcluidas = osUnicas.filter(numOS => {
                const entradas = orders.filter(o => o.numeroOS === numOS);
                entradas.sort((a, b) => new Date(b.data) - new Date(a.data));
                return entradas[0].status === 'Conclu√≠da';
            });
            document.getElementById('totalConcluidas').textContent = osConcluidas.length;
            
            const hoje = new Date().toISOString().split('T')[0];
            const osHoje = [...new Set(orders.filter(o => o.data === hoje).map(o => o.numeroOS))];
            document.getElementById('totalHoje').textContent = osHoje.length;
        }

        function filtrarMes() {
            const mes = document.getElementById('filtroMes').value;
            if (!mes) { renderOrders(); return; }
            const [ano, mesNum] = mes.split('-').map(Number);
            const filtradas = orders.filter(o => {
                const d = new Date(o.data + 'T00:00:00');
                return d.getMonth() + 1 === mesNum && d.getFullYear() === ano;
            });
            renderOrders(filtradas);
        }

        function buscarOS(termo) {
            if (!termo.trim()) { renderOrders(); return; }
            const termoLower = termo.toLowerCase();
            const filtradas = orders.filter(o => 
                o.numeroOS.toLowerCase().includes(termoLower) ||
                o.descricao.toLowerCase().includes(termoLower)
            );
            renderOrders(filtradas);
        }

        function baixarRelatorioMes() {
            const mes = document.getElementById('filtroMes').value;
            if (!mes) { showToast('Selecione um m√™s', 'error'); return; }
            const [ano, mesNum] = mes.split('-').map(Number);
            const ordens = orders.filter(o => {
                const d = new Date(o.data + 'T00:00:00');
                return d.getMonth() + 1 === mesNum && d.getFullYear() === ano;
            });
            if (ordens.length === 0) { showToast('Nenhuma O.S neste m√™s', 'error'); return; }
            gerarPDF(ordens, `Relat√≥rio Mensal - ${new Date(ano, mesNum - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`);
        }

        function baixarRelatorioSemana() {
            const hoje = new Date();
            const inicio = new Date(hoje);
            inicio.setDate(hoje.getDate() - hoje.getDay());
            const fim = new Date(inicio);
            fim.setDate(inicio.getDate() + 6);
            const ordens = orders.filter(o => {
                const d = new Date(o.data + 'T00:00:00');
                return d >= inicio && d <= fim;
            });
            if (ordens.length === 0) { showToast('Nenhuma O.S esta semana', 'error'); return; }
            gerarPDF(ordens, `Relat√≥rio Semanal - ${inicio.toLocaleDateString('pt-BR')} a ${fim.toLocaleDateString('pt-BR')}`);
        }

        function gerarPDF(ordens, titulo) {
            const ordensAgrupadas = {};
            ordens.forEach(order => {
                if (!ordensAgrupadas[order.numeroOS]) ordensAgrupadas[order.numeroOS] = [];
                ordensAgrupadas[order.numeroOS].push(order);
            });

            let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${titulo}</title>
            <style>
                body { font-family: Arial, sans-serif; color: #333; margin: 2cm; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #6366f1; padding-bottom: 15px; }
                .header h1 { color: #6366f1; margin: 0; font-size: 24px; }
                .order-group { border: 2px solid #e5e7eb; margin: 20px 0; padding: 20px; border-radius: 12px; page-break-inside: avoid; background: #fafafa; }
                .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; }
                .order-number { font-size: 20px; font-weight: bold; }
                .status { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; }
                .status-concluida { background: #d1fae5; color: #065f46; }
                .apontamento { background: white; border-left: 4px solid #6366f1; padding: 12px; margin: 8px 0; border-radius: 6px; }
            </style></head><body><div class="header"><h1>‚öôÔ∏è ${titulo}</h1><p>Gerado em ${new Date().toLocaleDateString('pt-BR')}</p></div>`;

            Object.keys(ordensAgrupadas).forEach(numeroOS => {
                const apontamentos = ordensAgrupadas[numeroOS];
                apontamentos.sort((a, b) => new Date(a.data) - new Date(b.data));
                const ultimo = apontamentos[apontamentos.length - 1];
                
                html += `<div class="order-group"><div class="order-header"><span class="order-number">O.S ${numeroOS}</span><span class="status status-${ultimo.status.toLowerCase().replace(' ', '-')}">${ultimo.status}</span></div><p><strong>Descri√ß√£o:</strong> ${ultimo.descricao}</p><p><strong>Apontamentos (${apontamentos.length}):</strong></p>`;
                
                apontamentos.forEach(apt => {
                    const data = new Date(apt.data + 'T00:00:00').toLocaleDateString('pt-BR');
                    const duracao = apt.horaInicio && apt.horaFim ? calculateDuration(apt.horaInicio, apt.horaFim, apt.descontarAlmoco || 'nao') : '-';
                    html += `<div class="apontamento">üìÖ ${data} ${apt.horaInicio ? '| üïê ' + apt.horaInicio + ' - ' + apt.horaFim : ''} ${apt.horaInicio && apt.horaFim ? '| ‚è± ' + duracao : ''}${apt.descontarAlmoco === 'sim' ? ' (üçΩÔ∏è Almo√ßo descontado)' : ''}</div>`;
                });
                
                html += `</div>`;
            });

            html += `</body></html>`;
            
            const janela = window.open('', '_blank');
            janela.document.write(html);
            janela.document.close();
            setTimeout(() => janela.print(), 500);
            showToast('Relat√≥rio gerado!');
        }

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveOrder(); }
            if (e.key === 'Escape' && editingId) cancelEdit();
        });

        loadOrders();
        document.getElementById('data').valueAsDate = new Date();
    </script>
</body>
</html>
